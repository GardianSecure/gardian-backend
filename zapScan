// zapScan.js
const axios = require("axios");

const ZAP_API = "http://127.0.0.1:8080";
const API_KEY = process.env.ZAP_API_KEY || "gardian123";

// Helper: sleep
const sleep = (ms) => new Promise((r) => setTimeout(r, ms));

// Helper: wait for ZAP API readiness
async function waitForZapReady(maxMs = 3 * 60 * 1000) {
  const deadline = Date.now() + maxMs;
  while (Date.now() < deadline) {
    try {
      const res = await axios.get(`${ZAP_API}/JSON/core/view/version/`, {
        params: { apikey: API_KEY }
      });
      if (res.data) {
        console.log("‚úÖ ZAP API is online:", res.data);
        return true;
      }
    } catch (err) {
      console.log(`‚è≥ Waiting for ZAP API... ${err.message}`);
    }
    await sleep(3000);
  }
  throw new Error("‚ùå ZAP API did not become ready within 3 minutes");
}

// Helper: confirm required add-ons are loaded
async function waitForAddons(addons = ["spider", "ascan"], maxMs = 60 * 1000) {
  const deadline = Date.now() + maxMs;
  while (Date.now() < deadline) {
    try {
      // Use the "core/view/loadedAddons" endpoint (list loaded add-ons)
      const res = await axios.get(`${ZAP_API}/JSON/core/view/loadedAddons/`, {
        params: { apikey: API_KEY }
      });
      const loaded = (res.data?.loadedAddons || []).map((a) => a.id || a);
      const allPresent = addons.every((id) => loaded.includes(id));
      if (allPresent) {
        console.log("‚úÖ Required add-ons loaded:", addons.join(", "));
        return true;
      }
      console.log("‚è≥ Add-ons not ready yet. Loaded:", loaded.join(", "));
    } catch (err) {
      console.log(`‚è≥ Checking add-ons... ${err.message}`);
    }
    await sleep(3000);
  }
  throw new Error(`‚ùå Required add-ons not loaded in time: ${addons.join(", ")}`);
}

async function runZapScan(siteUrl) {
  // 1) Wait for ZAP API to be online
  await waitForZapReady();

  // 2) Ensure spider + ascan add-ons are loaded
  await waitForAddons(["spider", "ascan"]);

  // 3) Spider the target
  console.log("üï∑Ô∏è Starting spider to crawl site...");
  let spiderId;
  try {
    const spiderRes = await axios.get(`${ZAP_API}/JSON/spider/action/scan/`, {
      params: {
        apikey: API_KEY,
        url: siteUrl,
        recurse: true
      }
    });
    if (!spiderRes.data?.scan) {
      throw new Error(`Spider start failed: ${JSON.stringify(spiderRes.data)}`);
    }
    spiderId = spiderRes.data.scan;
    console.log(`üï∑Ô∏è Spider started with ID: ${spiderId}`);
  } catch (err) {
    // If NO_IMPLEMENTOR ever happens, it means spider wasn‚Äôt loaded‚Äîour wait fixes that.
    console.error(`‚ùå Spider start error: ${err.message}`);
    return { status: "error", alerts: [], error: "Spider could not start" };
  }

  // 4) Wait for spider completion
  try {
    let spiderProgress = 0;
    const spiderDeadline = Date.now() + 5 * 60 * 1000; // 5 minutes
    while (spiderProgress < 100 && Date.now() < spiderDeadline) {
      const statusRes = await axios.get(`${ZAP_API}/JSON/spider/view/status/`, {
        params: { apikey: API_KEY, scanId: spiderId }
      });
      spiderProgress = parseInt(statusRes.data.status, 10);
      console.log(`‚è≥ Spider progress: ${spiderProgress}%`);
      await sleep(3000);
    }
    if (spiderProgress < 100) {
      console.warn("‚ö†Ô∏è Spider timed out before reaching 100%");
    } else {
      console.log("‚úÖ Spider completed");
    }
  } catch (err) {
    console.error(`‚ùå Spider status error: ${err.message}`);
  }

  // 5) Start active scan
  console.log("üîç Starting active scan...");
  let scanId;
  try {
    const scanRes = await axios.get(`${ZAP_API}/JSON/ascan/action/scan/`, {
      params: {
        apikey: API_KEY,
        url: siteUrl,
        recurse: true,
        inScopeOnly: false
      }
    });
    if (!scanRes.data?.scan) {
      throw new Error(`Active scan start failed: ${JSON.stringify(scanRes.data)}`);
    }
    scanId = scanRes.data.scan;
    console.log(`üîç Active scan started with ID: ${scanId}`);
  } catch (err) {
    console.error(`‚ùå Active scan start error: ${err.message}`);
    return { status: "error", alerts: [], error: "Active scan could not start" };
  }

  // 6) Poll active scan status
  let progress = 0;
  const scanDeadline = Date.now() + 10 * 60 * 1000; // 10 minutes
  while (progress < 100 && Date.now() < scanDeadline) {
    try {
      const statusRes = await axios.get(`${ZAP_API}/JSON/ascan/view/status/`, {
        params: { apikey: API_KEY, scanId }
      });
      progress = parseInt(statusRes.data.status, 10);
      console.log(`‚è≥ Scan progress: ${progress}%`);
    } catch (err) {
      console.warn(`‚ö†Ô∏è Failed to fetch scan status: ${err.message}`);
    }
    await sleep(5000);
  }

  if (progress < 100) {
    console.warn("‚ö†Ô∏è Active scan timed out before reaching 100%");
    // Still try to fetch whatever alerts exist
  } else {
    console.log("‚úÖ Active scan completed");
  }

  // 7) Fetch alerts (always attempt; we may have partial data)
  try {
    const alertsRes = await axios.get(`${ZAP_API}/JSON/alert/view/alerts/`, {
      params: { apikey: API_KEY, baseurl: siteUrl }
    });
    const alerts = alertsRes.data.alerts || [];
    console.log(`‚úÖ Retrieved ${alerts.length} alerts`);
    return { status: progress < 100 ? "partial" : "completed", alerts };
  } catch (err) {
    console.error(`‚ùå Failed to fetch alerts: ${err.message}`);
    return { status: "error", alerts: [], error: "Could not retrieve alerts" };
  }
}

module.exports = { runZapScan };
