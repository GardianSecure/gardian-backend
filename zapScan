//zapScan
const axios = require("axios");

const zapPort = process.env.ZAP_PORT || 8080; // must match launch.js
const ZAP_API = `http://127.0.0.1:${zapPort}`;
const API_KEY = process.env.ZAP_API_KEY || "gardian123";
const sleep = ms => new Promise(r => setTimeout(r, ms));

async function waitForZapReady(maxMs = 180000) {
  // Short delay before first poll, so API extension has time to load
  await sleep(5000);

  const deadline = Date.now() + maxMs;
  while (Date.now() < deadline) {
    try {
      const res = await axios.get(`${ZAP_API}/JSON/core/view/version/`, { params: { apikey: API_KEY } });
      if (res.data) {
        console.log("âœ… ZAP API is online:", res.data);
        return true;
      }
    } catch {
      console.log("â³ Waiting for ZAP API...");
    }
    await sleep(3000);
  }
  throw new Error("âŒ ZAP API did not become ready in time");
}

async function waitForImplementors(maxMs = 90000) {
  const deadline = Date.now() + maxMs;
  while (Date.now() < deadline) {
    let spiderOK = false;
    let ascanOK = false;

    try {
      await axios.get(`${ZAP_API}/JSON/spider/view/scans/`, { params: { apikey: API_KEY } });
      spiderOK = true;
    } catch {}

    try {
      await axios.get(`${ZAP_API}/JSON/ascan/view/scans/`, { params: { apikey: API_KEY } });
      ascanOK = true;
    } catch {}

    if (spiderOK && ascanOK) {
      console.log("âœ… Implementors ready: spider + ascan");
      return true;
    }

    console.log(`â³ Implementors not ready yet (spider=${spiderOK}, ascan=${ascanOK})`);
    await sleep(3000);
  }
  throw new Error("âŒ Required implementors (spider/ascan) not ready in time");
}

async function runZapScan(siteUrl) {
  await waitForZapReady();
  await waitForImplementors();

  // Spider
  console.log("ðŸ•·ï¸ Starting spider...");
  const spiderRes = await axios.get(`${ZAP_API}/JSON/spider/action/scan/`, {
    params: { apikey: API_KEY, url: siteUrl, recurse: true }
  });
  const spiderId = spiderRes.data?.scan;
  if (!spiderId) throw new Error("âŒ Spider failed to start");
  let spiderProgress = 0;
  while (spiderProgress < 100) {
    const statusRes = await axios.get(`${ZAP_API}/JSON/spider/view/status/`, {
      params: { apikey: API_KEY, scanId: spiderId }
    });
    spiderProgress = parseInt(statusRes.data?.status ?? "0", 10);
    console.log(`â³ Spider progress: ${spiderProgress}%`);
    await sleep(3000);
  }
  console.log("âœ… Spider completed");

  // Active scan
  console.log("ðŸ” Starting active scan...");
  const scanRes
