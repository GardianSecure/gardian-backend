// zapScan.js
const axios = require("axios");

const ZAP_API = "http://127.0.0.1:8080";
const API_KEY = process.env.ZAP_API_KEY || "gardian123";

const sleep = (ms) => new Promise((r) => setTimeout(r, ms));

// Wait for ZAP API to come online
async function waitForZapReady(maxMs = 3 * 60 * 1000) {
  const deadline = Date.now() + maxMs;
  while (Date.now() < deadline) {
    try {
      const res = await axios.get(`${ZAP_API}/JSON/core/view/version/`, {
        params: { apikey: API_KEY }
      });
      if (res.data) {
        console.log("âœ… ZAP API is online:", res.data);
        return true;
      }
    } catch (err) {
      console.log(`â³ Waiting for ZAP API... ${err.message}`);
    }
    await sleep(3000);
  }
  throw new Error("âŒ ZAP API did not become ready within 3 minutes");
}

// Probe actual endpoints to confirm add-on implementors are loaded
// We use spider option endpoints and ascan views that only exist if their add-ons are initialized.
async function waitForImplementors(maxMs = 90 * 1000) {
  const deadline = Date.now() + maxMs;
  while (Date.now() < deadline) {
    let spiderOK = false;
    let ascanOK = false;

    try {
      // Exists only if Spider add-on is initialized
      await axios.get(`${ZAP_API}/JSON/spider/view/optionMaxChildren/`, {
        params: { apikey: API_KEY }
      });
      spiderOK = true;
    } catch (e) {
      spiderOK = false;
    }

    try {
      // Exists only if Active Scan add-on is initialized
      await axios.get(`${ZAP_API}/JSON/ascan/view/scans/`, {
        params: { apikey: API_KEY }
      });
      ascanOK = true;
    } catch (e) {
      ascanOK = false;
    }

    if (spiderOK && ascanOK) {
      console.log("âœ… Implementors ready: spider + ascan");
      return true;
    }

    console.log(`â³ Implementors not ready yet (spider=${spiderOK}, ascan=${ascanOK})`);
    await sleep(3000);
  }
  throw new Error("âŒ Required implementors (spider/ascan) not ready in time");
}

async function runZapScan(siteUrl) {
  // 1) Wait for ZAP API
  await waitForZapReady();

  // 2) Confirm spider + ascan implementors are loaded
  await waitForImplementors();

  // 3) Start spider with retries (handles NO_IMPLEMENTOR races if any remain)
  console.log("ðŸ•·ï¸ Starting spider to crawl site...");
  let spiderId;
  let spiderAttempts = 0;
  while (!spiderId && spiderAttempts < 5) {
    try {
      const spiderRes = await axios.get(`${ZAP_API}/JSON/spider/action/scan/`, {
        params: { apikey: API_KEY, url: siteUrl, recurse: true }
      });
      if (!spiderRes.data?.scan) throw new Error(`Spider start failed: ${JSON.stringify(spiderRes.data)}`);
      spiderId = spiderRes.data.scan;
      console.log(`ðŸ•·ï¸ Spider started with ID: ${spiderId}`);
    } catch (err) {
      // NO_IMPLEMENTOR / 400s â†’ wait and retry
      console.warn(`âš ï¸ Spider start attempt ${spiderAttempts + 1} failed: ${err.message}`);
      await sleep(5000);
      spiderAttempts++;
    }
  }
  if (!spiderId) {
    console.error("âŒ Spider could not start after retries");
    return { status: "error", alerts: [], error: "Spider could not start" };
  }

  // 4) Wait for spider completion
  try {
    let spiderProgress = 0;
    const spiderDeadline = Date.now() + 5 * 60 * 1000; // 5 minutes
    while (spiderProgress < 100 && Date.now() < spiderDeadline) {
      const statusRes = await axios.get(`${ZAP_API}/JSON/spider/view/status/`, {
        params: { apikey: API_KEY, scanId: spiderId }
      });
      spiderProgress = parseInt(statusRes.data.status, 10);
      console.log(`â³ Spider progress: ${spiderProgress}%`);
      await sleep(3000);
    }
    if (spiderProgress < 100) {
      console.warn("âš ï¸ Spider timed out before reaching 100%");
    } else {
      console.log("âœ… Spider completed");
    }
  } catch (err) {
    console.error(`âŒ Spider status error: ${err.message}`);
  }

  // 5) Start active scan with retries
  console.log("ðŸ” Starting active scan...");
  let scanId;
  let ascanAttempts = 0;
  while (!scanId && ascanAttempts < 5) {
    try {
      const scanRes = await axios.get(`${ZAP_API}/JSON/ascan/action/scan/`, {
        params: { apikey: API_KEY, url: siteUrl, recurse: true, inScopeOnly: false }
      });
      if (!scanRes.data?.scan) throw new Error(`Active scan start failed: ${JSON.stringify(scanRes.data)}`);
      scanId = scanRes.data.scan;
      console.log(`ðŸ” Active scan started with ID: ${scanId}`);
    } catch (err) {
      console.warn(`âš ï¸ Active scan start attempt ${ascanAttempts + 1} failed: ${err.message}`);
      await sleep(5000);
      ascanAttempts++;
    }
  }
  if (!scanId) {
    console.error("âŒ Active scan could not start after retries");
    return { status: "error", alerts: [], error: "Active scan could not start" };
  }

  // 6) Poll active scan status
  let progress = 0;
  const scanDeadline = Date.now() + 10 * 60 * 1000; // 10 minutes
  while (progress < 100 && Date.now() < scanDeadline) {
    try {
      const statusRes = await axios.get(`${ZAP_API}/JSON/ascan/view/status/`, {
        params: { apikey: API_KEY, scanId }
      });
      progress = parseInt(statusRes.data.status, 10);
      console.log(`â³ Scan progress: ${progress}%`);
    } catch (err) {
      console.warn(`âš ï¸ Failed to fetch scan status: ${err.message}`);
    }
    await sleep(5000);
  }

  if (progress < 100) {
    console.warn("âš ï¸ Active scan timed out before reaching 100% â€” fetching partial alerts");
  } else {
    console.log("âœ… Active scan completed");
  }

  // 7) Fetch alerts
  try {
    const alertsRes = await axios.get(`${ZAP_API}/JSON/alert/view/alerts/`, {
      params: { apikey: API_KEY, baseurl: siteUrl }
    });
    const alerts = alertsRes.data.alerts || [];
    console.log(`âœ… Retrieved ${alerts.length} alerts`);
    return { status: progress < 100 ? "partial" : "completed", alerts };
  } catch (err) {
    console.error(`âŒ Failed to fetch alerts: ${err.message}`);
    return { status: "error", alerts: [], error: "Could not retrieve alerts" };
  }
}

module.exports = { runZapScan };
