// zapScan.js
const axios = require("axios");

// ZAP runs inside the same container, so use localhost
const ZAP_API = "http://127.0.0.1:8080";
const API_KEY = "gardian123"; // must match your start.sh config

async function runZapScan(siteUrl) {
  // Wait until ZAP is ready
  for (let i = 1; i <= 40; i++) {
    try {
      const res = await axios.get(`${ZAP_API}/JSON/core/view/version/?apikey=${API_KEY}`);
      if (res.data) {
        console.log("‚úÖ ZAP daemon is ready");
        break;
      }
    } catch {
      console.log(`‚è≥ Waiting for ZAP... attempt ${i}/40`);
      await new Promise(r => setTimeout(r, 3000));
    }
    if (i === 40) throw new Error("ZAP daemon did not become ready in time");
  }

  // Start active scan
  const scanRes = await axios.get(
    `${ZAP_API}/JSON/ascan/action/scan/?apikey=${API_KEY}&url=${encodeURIComponent(siteUrl)}`
  );
  const scanId = scanRes.data.scan;
  console.log(`üîç Scan started with ID: ${scanId}`);

  // Poll until scan completes
  let progress = 0;
  while (progress < 100) {
    const statusRes = await axios.get(
      `${ZAP_API}/JSON/ascan/view/status/?apikey=${API_KEY}&scanId=${scanId}`
    );
    progress = parseInt(statusRes.data.status, 10);
    console.log(`‚è≥ Scan progress: ${progress}%`);
    await new Promise(r => setTimeout(r, 5000));
  }

  // Fetch alerts
  const alertsRes = await axios.get(
    `${ZAP_API}/JSON/core/view/alerts/?apikey=${API_KEY}&baseurl=${encodeURIComponent(siteUrl)}`
  );
  return alertsRes.data.alerts || [];
}

module.exports = { runZapScan };
