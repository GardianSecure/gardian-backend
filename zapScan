// zapScan.js
const axios = require('axios');

const ZAP_API = 'http://localhost:8080'; // ZAP default port
const API_KEY = ''; // Add your ZAP API key here if required

async function runZapScan(targetUrl) {
  try {
    // Start spider scan
    await axios.get(`${ZAP_API}/JSON/spider/action/scan`, {
      params: { url: targetUrl, apikey: API_KEY }
    });

    // Wait for spider to complete
    let status = '0';
    while (status !== '100') {
      const res = await axios.get(`${ZAP_API}/JSON/spider/view/status`, {
        params: { apikey: API_KEY }
      });
      status = res.data.status;
      await new Promise(resolve => setTimeout(resolve, 2000));
    }

    // Fetch passive alerts
    const alerts = await axios.get(`${ZAP_API}/JSON/core/view/alerts`, {
      params: { baseurl: targetUrl, apikey: API_KEY }
    });

    return alerts.data.alerts.map(alert => ({
      name: alert.alert,
      risk: alert.risk,
      url: alert.url,
      description: alert.description,
      solution: alert.solution
    }));
  } catch (err) {
    console.error('ZAP scan failed:', err.message);
    return [];
  }
}

module.exports = { runZapScan };