// zapScan.js
const axios = require("axios");

const ZAP_API = "http://127.0.0.1:8080";
const API_KEY = process.env.ZAP_API_KEY || "gardian123";
const sleep = ms => new Promise(r => setTimeout(r, ms));

async function waitForZapReady(maxMs = 180000) {
  const deadline = Date.now() + maxMs;
  while (Date.now() < deadline) {
    try {
      const res = await axios.get(`${ZAP_API}/JSON/core/view/version/`, { params: { apikey: API_KEY } });
      if (res.data) {
        console.log("‚úÖ ZAP API is online:", res.data);
        return true;
      }
    } catch {
      console.log("‚è≥ Waiting for ZAP API...");
    }
    await sleep(3000);
  }
  throw new Error("‚ùå ZAP API did not become ready in time");
}

// Wait until spider and ascan add-ons are initialized
async function waitForImplementors(maxMs = 90000) {
  const deadline = Date.now() + maxMs;
  while (Date.now() < deadline) {
    let spiderOK = false;
    let ascanOK = false;

    try {
      await axios.get(`${ZAP_API}/JSON/spider/view/scans/`, { params: { apikey: API_KEY } });
      spiderOK = true;
    } catch { spiderOK = false; }

    try {
      await axios.get(`${ZAP_API}/JSON/ascan/view/scans/`, { params: { apikey: API_KEY } });
      ascanOK = true;
    } catch { ascanOK = false; }

    if (spiderOK && ascanOK) {
      console.log("‚úÖ Implementors ready: spider + ascan");
      return true;
    }

    console.log(`‚è≥ Implementors not ready yet (spider=${spiderOK}, ascan=${ascanOK})`);
    await sleep(3000);
  }
  throw new Error("‚ùå Required implementors (spider/ascan) not ready in time");
}

async function startSpiderWithRetry(siteUrl, maxAttempts = 5) {
  for (let attempt = 1; attempt <= maxAttempts; attempt++) {
    try {
      const res = await axios.get(`${ZAP_API}/JSON/spider/action/scan/`, {
        params: { apikey: API_KEY, url: siteUrl, recurse: true }
      });
      const spiderId = res.data?.scan;
      if (!spiderId) throw new Error(`Spider start failed: ${JSON.stringify(res.data)}`);
      console.log(`üï∑Ô∏è Spider started with ID: ${spiderId}`);
      return spiderId;
    } catch (err) {
      const msg = String(err?.response?.data?.message || err.message || "");
      console.warn(`‚ö†Ô∏è Spider start attempt ${attempt} failed: ${msg}`);
      if (attempt < maxAttempts) await sleep(5000);
    }
  }
  throw new Error("‚ùå Spider could not start after retries");
}

async function pollSpider(spiderId, maxMs = 300000) {
  const deadline = Date.now() + maxMs;
  let progress = 0;
  while (progress < 100 && Date.now() < deadline) {
    try {
      const statusRes = await axios.get(`${ZAP_API}/JSON/spider/view/status/`, {
        params: { apikey: API_KEY, scanId: spiderId }
      });
      progress = parseInt(statusRes.data?.status ?? "0", 10);
      console.log(`‚è≥ Spider progress: ${progress}%`);
    } catch (err) {
      const msg = String(err?.response?.data?.message || err.message || "");
      console.warn(`‚ö†Ô∏è Spider status check failed: ${msg}`);
    }
    await sleep(3000);
  }
  return progress >= 100;
}

async function runZapScan(siteUrl) {
  await waitForZapReady();
  await waitForImplementors();

  // Spider
  const spiderId = await startSpiderWithRetry(siteUrl);
  const spiderDone = await pollSpider(spiderId);
  if (spiderDone) console.log("‚úÖ Spider completed");
  else console.warn("‚ö†Ô∏è Spider timed out before reaching 100%");

  // Active scan
  console.log("üîç Starting active scan...");
  let scanId;
  try {
    const scanRes = await axios.get(`${ZAP_API}/JSON/ascan/action/scan/`, {
      params: { apikey: API_KEY, url: siteUrl, recurse: true, inScopeOnly: false }
    });
    scanId = scanRes.data?.scan;
    if (!scanId) throw new Error(`Active scan start failed: ${JSON.stringify(scanRes.data)}`);
    console.log(`üîç Active scan started with ID: ${scanId}`);
  } catch (err) {
    const msg = String(err?.response?.data?.message || err.message || "");
    console.error(`‚ùå Active scan start error: ${msg}`);
    return { status: "error", alerts: [], error: "Active scan could not start" };
  }

  // Poll active scan
  let progress = 0;
  const deadline = Date.now() + 600000;
  while (progress < 100 && Date.now() < deadline) {
    try {
      const statusRes = await axios.get(`${ZAP_API}/JSON/ascan/view/status/`, {
        params: { apikey: API_KEY, scanId }
      });
      progress = parseInt(statusRes.data?.status ?? "0", 10);
      console.log(`‚è≥ Scan progress: ${progress}%`);
    } catch (err) {
      const msg = String(err?.response?.data?.message || err.message || "");
      console.warn(`‚ö†Ô∏è Scan status check failed: ${msg}`);
    }
    await sleep(5000);
  }

  if (progress < 100) console.warn("‚ö†Ô∏è Active scan timed out ‚Äî fetching partial alerts");
  else console.log("‚úÖ Active scan completed");

  // Fetch alerts
  try {
    const alertsRes = await axios.get(`${ZAP_API}/JSON/alert/view/alerts/`, {
      params: { apikey: API_KEY, baseurl: siteUrl }
    });
    const alerts = alertsRes.data.alerts || [];
    console.log(`‚úÖ Retrieved ${alerts.length} alerts`);
    return { status: progress < 100 ? "partial" : "completed", alerts };
  } catch (err) {
    const msg = String(err?.response?.data?.message || err.message || "");
    console.error(`‚ùå Failed to fetch alerts: ${msg}`);
    return { status: "error", alerts: [], error: "Could not retrieve alerts" };
  }
}

module.exports = { runZapScan };
