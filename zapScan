const axios = require("axios");

const ZAP_API = "http://127.0.0.1:8080";
const API_KEY = process.env.ZAP_API_KEY || "gardian123";

async function runZapScan(siteUrl) {
  // Wait until ZAP is ready (max 3 minutes, break early if ready)
  const timeout = Date.now() + 3 * 60 * 1000; // 3 minutes
  let ready = false;

  while (Date.now() < timeout && !ready) {
    try {
      const res = await axios.get(`${ZAP_API}/JSON/core/view/version/`, {
        params: { apikey: API_KEY }
      });
      if (res.data) {
        console.log("‚úÖ ZAP is fully initialized and ready to scan");
        ready = true;
        break;
      }
    } catch (err) {
      console.log(`‚è≥ Waiting for ZAP... ${err.message}`);
    }
    await new Promise(r => setTimeout(r, 3000));
  }

  if (!ready) {
    throw new Error("‚ùå ZAP daemon did not become ready within 3 minutes");
  }

  // üï∑Ô∏è Spider the site first
  console.log("üï∑Ô∏è Starting spider to crawl site...");
  const spiderRes = await axios.get(`${ZAP_API}/JSON/spider/action/scan/`, {
    params: {
      apikey: API_KEY,
      url: siteUrl,
      recurse: true
    }
  });
  const spiderId = spiderRes.data.scan;
  console.log(`üï∑Ô∏è Spider started with ID: ${spiderId}`);

  // Wait for spider to complete
  let spiderProgress = 0;
  while (spiderProgress < 100) {
    const statusRes = await axios.get(`${ZAP_API}/JSON/spider/view/status/`, {
      params: { apikey: API_KEY, scanId: spiderId }
    });
    spiderProgress = parseInt(statusRes.data.status, 10);
    console.log(`‚è≥ Spider progress: ${spiderProgress}%`);
    await new Promise(r => setTimeout(r, 3000));
  }
  console.log("‚úÖ Spider completed");

  // üîç Start active scan
  const scanRes = await axios.get(`${ZAP_API}/JSON/ascan/action/scan/`, {
    params: {
      apikey: API_KEY,
      url: siteUrl,
      recurse: true,
      inScopeOnly: false
    }
  });

  if (!scanRes.data.scan) {
    throw new Error(`‚ùå Active scan failed: ${JSON.stringify(scanRes.data)}`);
  }

  const scanId = scanRes.data.scan;
  console.log(`üîç Active scan started with ID: ${scanId}`);

  // ‚è≥ Poll until scan completes
  let progress = 0;
  const scanTimeout = Date.now() + 10 * 60 * 1000; // 10 minutes
  while (progress < 100 && Date.now() < scanTimeout) {
    try {
      const statusRes = await axios.get(`${ZAP_API}/JSON/ascan/view/status/`, {
        params: { apikey: API_KEY, scanId }
      });
      progress = parseInt(statusRes.data.status, 10);
      console.log(`‚è≥ Scan progress: ${progress}%`);
    } catch (err) {
      console.warn(`‚ö†Ô∏è Failed to fetch scan status: ${err.message}`);
    }
    await new Promise(r => setTimeout(r, 5000));
  }

  if (progress < 100) {
    console.warn("‚ö†Ô∏è Active scan timed out before reaching 100%");
  } else {
    console.log("‚úÖ Active scan completed");
  }

  // ‚úÖ Fetch alerts
  try {
    const alertsRes = await axios.get(`${ZAP_API}/JSON/alert/view/alerts/`, {
      params: { apikey: API_KEY, baseurl: siteUrl }
    });
    console.log(`‚úÖ Retrieved ${alertsRes.data.alerts?.length || 0} alerts`);
    return alertsRes.data.alerts || [];
  } catch (err) {
    console.error(`‚ùå Failed to fetch alerts: ${err.message}`);
    return [{ risk: "Error", issue: "Could not retrieve alerts from ZAP." }];
  }
}

module.exports = { runZapScan };
