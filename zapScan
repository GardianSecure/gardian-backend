// zapScan.js
const axios = require("axios");

const ZAP_API = "http://127.0.0.1:8080";
const API_KEY = process.env.ZAP_API_KEY || "gardian123";
const sleep = ms => new Promise(r => setTimeout(r, ms));

async function waitForZapReady(maxMs = 3 * 60 * 1000) {
  const deadline = Date.now() + maxMs;
  while (Date.now() < deadline) {
    try {
      const res = await axios.get(`${ZAP_API}/JSON/core/view/version/`, {
        params: { apikey: API_KEY }
      });
      if (res.data) {
        console.log("âœ… ZAP API is online:", res.data);
        return true;
      }
    } catch {
      console.log("â³ Waiting for ZAP API...");
    }
    await sleep(3000);
  }
  throw new Error("âŒ ZAP API did not become ready in time");
}

async function waitForSpider(maxMs = 90 * 1000) {
  const deadline = Date.now() + maxMs;
  while (Date.now() < deadline) {
    try {
      await axios.get(`${ZAP_API}/JSON/spider/view/status/`, {
        params: { apikey: API_KEY }
      });
      console.log("âœ… Spider addâ€‘on is ready");
      return true;
    } catch (err) {
      if (String(err).includes("NO_IMPLEMENTOR")) {
        console.log("â³ Spider not ready yet...");
      } else {
        console.log("âš ï¸ Spider check error:", err.message);
      }
    }
    await sleep(3000);
  }
  throw new Error("âŒ Spider addâ€‘on did not become ready in time");
}

async function runZapScan(siteUrl) {
  await waitForZapReady();
  await waitForSpider();

  // ðŸ•·ï¸ Spider
  console.log("ðŸ•·ï¸ Starting spider...");
  const spiderRes = await axios.get(`${ZAP_API}/JSON/spider/action/scan/`, {
    params: { apikey: API_KEY, url: siteUrl, recurse: true }
  });
  const spiderId = spiderRes.data.scan;
  console.log(`ðŸ•·ï¸ Spider started with ID: ${spiderId}`);

  let spiderProgress = 0;
  while (spiderProgress < 100) {
    const statusRes = await axios.get(`${ZAP_API}/JSON/spider/view/status/`, {
      params: { apikey: API_KEY, scanId: spiderId }
    });
    spiderProgress = parseInt(statusRes.data.status, 10);
    console.log(`â³ Spider progress: ${spiderProgress}%`);
    await sleep(3000);
  }
  console.log("âœ… Spider completed");

  // ðŸ” Active scan
  console.log("ðŸ” Starting active scan...");
  const scanRes = await axios.get(`${ZAP_API}/JSON/ascan/action/scan/`, {
    params: { apikey: API_KEY, url: siteUrl, recurse: true, inScopeOnly: false }
  });
  const scanId = scanRes.data.scan;
  console.log(`ðŸ” Active scan started with ID: ${scanId}`);

  let progress = 0;
  const deadline = Date.now() + 10 * 60 * 1000;
  while (progress < 100 && Date.now() < deadline) {
    const statusRes = await axios.get(`${ZAP_API}/JSON/ascan/view/status/`, {
      params: { apikey: API_KEY, scanId }
    });
    progress = parseInt(statusRes.data.status, 10);
    console.log(`â³ Scan progress: ${progress}%`);
    await sleep(5000);
  }

  if (progress < 100) {
    console.warn("âš ï¸ Active scan timed out");
  } else {
    console.log("âœ… Active scan completed");
  }

  // âœ… Alerts
  const alertsRes = await axios.get(`${ZAP_API}/JSON/alert/view/alerts/`, {
    params: { apikey: API_KEY, baseurl: siteUrl }
  });
  const alerts = alertsRes.data.alerts || [];
  console.log(`âœ… Retrieved ${alerts.length} alerts`);
  return { status: progress < 100 ? "partial" : "completed", alerts };
}

module.exports = { runZapScan };
